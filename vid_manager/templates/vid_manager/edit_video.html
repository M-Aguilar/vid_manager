{% extends "vid_manager/base.html" %}
{% load bootstrap4 %}

{% block title %}Edit {{video.title}}{% endblock %}

{% block header %}
	<div class="jumbotron bg-dark text-light display-4 mt-5 pb-3 pt-1 mb-3 text-center">
		<h2>Edit Video</h2>
	</div>
	{% load bit_format %}
	<h4>Video Info</h4>
	<div class="row">
		<div class="col-6 col-md-3 col-lg-2">Date Added: {{ video.date_added }}</div>
		<div class="col-6 col-md-3 col-lg-2">Release Date: {{ video.release_date }}</div>
		<div class="col-6 col-md-3 col-lg-2">Bitrate: {{ video.bitrate }} ({{ video.bitrate|bit_rate }})</div>
		<div class="col-6 col-md-3 col-lg-2">Size: {{ video.size }} ({{ video.size|bit_size }})</div>		
		<div class="col-6 col-md-3 col-lg-2">Length: {{ video.length|time }}</div>
		<div class="col-6 col-md-3 col-lg-2">Images: {{ video.image_set.count }}</div>
		<div class="col-6 col-md-3 col-lg-2">Events: {{ video.event_set.count }}</div>
		<div class="col-6 col-md-3 col-lg-2">Actor #: {{ video.actors.count }}</div>
		<div class="col-6 col-md-3 col-lg-2">Tag #: {{ video.tags.count }}</div>
		<div class="col-6 col-md-3 col-lg-2">Width: {{ video.width }}</div>
		<div class="col-6 col-md-3 col-lg-2">Height: {{ video.height }}</div>
	</div>
{% endblock %}

{% block content %}
<div class="container">
	<div class="messages mb-3">
	{% if messages %}
    	{% for message in messages %}
    	<div {% if message.tags %} class="rounded p-1 bg-{{ message.tags }}"{% endif %}>{{ message }}</div>
 	   	{% endfor %}
	{% endif %}
	</div>
	<div class="text-dark">
		<form action="{% url 'edit_video' video.id %}" method='post' enctype="multipart/form-data">
		{% csrf_token %}
		{% bootstrap_form form %}
		{% buttons %}
			<button name="submit" class="btn btn-dark">save changes</button>
			<a href="{{ video.path }}" class='btn btn-dark'>Video Source</a>
			<a href="{% url 'new_video_image' video.id %}" class="btn btn-dark">Add Image</a> 	
			<a href="{% url 'delete_images' video.id %}" class="btn btn-dark">Delete Images</a>
		{% endbuttons %}
		</form>
	</div>
</div>
<div class="d-flex row mx-4 eventrow">
	{% for event in video.event_set.all %}
	<div id='{{ event.id }}' class="col-4 col-md-2 mb-3">
		<div class="card mx-1">
			<div class="card-header">
				{{ event }} - {{ event.time }}
				<a href="{% url 'delete_event' event.id %}" id="delete_event" class="float-right btn btn-xs btn-dark rounded-circle my-1 px-2" value="{{ event.id }}">
					<div class="px-1 mb-1">
						<span>&times;</span>
					</div>
				</a>
			</div>
			<div class="card-body p-0">
				<img src="{{ event.url }}" width="100%" alt='No image'>
			</div>
		</div>
	</div>
	{% endfor %}
</div>
<div class="d-flex row mx-1">
{% for image in video.image_set.all %}
	<div class="col-4 col-md-2 p-0">
		<div class="card mx-1">
			<div class="card-header">
				{{ image.image.size|bit_size }}	
			</div>
			<div class="card-body p-0">
				<img src="{{ image.image.url }}" width="100%" alt='No image'>
			</div>
		</div>
	</div>
{% endfor %}
</div>
{% load static %}
<script type="text/javascript" src="{% static 'vid_manager/edit_sort.js' %}"></script>
<script>
$(".eventrow").on('click', "a#delete_event", function (e) {
	e.preventDefault();
	var new_url = "{% url 'delete_event' 0 %}".replace('0', $(this).attr('value'));
	$.ajax({
		type: 'GET',
		url: new_url,
		success: function (response) {
			var instance = JSON.parse(response["instance"]);
			var fields = instance[0]["fields"];
			var pk = instance[0]["pk"];
			$('.messages').empty();
			$('.messages').prepend(`<div class="rounded p-1 bg-success">Event "${fields["name"]}" has been removed.</div>`);
			$('#'+pk).remove();
		},

		error: function (response) {
			alert(response["responseJSON"]["error"]);
		}
	})
})
</script>
{% endblock %}
