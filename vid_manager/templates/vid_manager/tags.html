{% extends "vid_manager/base.html" %}
{% load bootstrap4 %}

{% block title %}Tags{% endblock %}

{% block header %}
<div class="jumbotron bg-dark text-light pt-1 pb-3 text-center display-4 mt-5 mb-0">
	<h2>{% if video %}{{ video }} {% endif %}Tags: {{ tags.paginator.count }}</h2>
</div>
<div class="mt-3">
	<div class="dropdown float-right">
		<button class="btn btn-dark dropdown-toggle" type="button" id="ddM" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="bi bi-sort-up"></i></button>
		 <div class="dropdown-menu dropdown-menu-right" aria-labelledby="ddM">
				{% load deslug clean %}
			{% for so in sort_options %}
			<a class="dropdown-item {% if sort|deslug == so %}active{% endif %}" href="?sort={% if so == sort %}-{% endif %}{{so}}">{% if sort == so %}-{% endif %}{{so|clean}}</a>
				{% empty %}
	  		{% endfor %}
			</div>
	</div>
	<a class='btn btn-dark' href="#add_tag" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="add_tag"><i class="bi bi-tag"></i> <i class="bi bi-plus"></i></a>
</div>
<div class="collapse" id="add_tag">
	<div class="card-body"> 
	{% buttons %}
		<form id="tag_form" action="{% url 'new_tag' %}" method='post' class="form">
			{% csrf_token %}
			{% bootstrap_form new_tag_form %}	
		</form>
	</div>
	{% endbuttons %}
</div>
<div class='d-flex row justify-content-center'>
	<span class="current text-center">
		Page <input id="pnum" type='number' minlength='1' max="{{ tags.paginator.num_pages }}" min='1' style="width: 35px" placeholder="{{ tags.number }}"> of {{ tags.paginator.num_pages }}
	</span>
	<a id="plink" href=""></a>
</div>
<div class="pagination d-flex justify-content-center">
	<span class="step-links">
		{% if tags.has_previous %}
		<a class="btn btn-sm btn-dark" href="?page=1{% if sort %}&{{sort}}{% endif %}">&laquo; first</a>
		<a class="btn btn-sm btn-dark" href="?page={{ tags.previous_page_number }}{% if sort %}&{{sort}}{% endif %}">previous</a>
		{% endif %}
		{% if tags.has_next %}
		<a class="btn btn-sm btn-dark" href="?page={{ tags.next_page_number }}{% if sort %}&{{sort}}{% endif %}">next</a>
		<a class="btn btn-sm btn-dark" href="?page={{ tags.paginator.num_pages }}{% if sort %}&{{sort}}{% endif %}">last &raquo;</a>
		{% endif %}
	</span>
</div>
{% endblock %}

{% block content %}
<div class="text-dark">
	{% if messages %}
	<div class="container messages mb-3">
    	{% for message in messages %}
    	<div {% if message.tags %} class="rounded px-4 py-3 bg-{{ message.tags }}"{% endif %}>{{ message }}</div>
	    {% endfor %}
	</div>
	{% endif %}
	<div id="tags">
		<div class="tagrow row mx-1">
			{% load static %}
			{% for tag in tags %}
			<div class="mb-4 col-sm-6 col-md-4 col-lg-3 col-xl-2 pb-3 px-1">
				<a href="{% url 'tag' tag.id %}">
					<div class="preview">
						<img src="{% if tag.img %}{{ tag.img.url }}{% else %}{% static 'vid_manager/blank_image.png' %}{% endif %}" height="auto" width="100%" alt=''>
						<div class="img-top-left">{{ tag }}</div>
					</div>
				</a>
			</div>
			{% empty %}
			<div class='container'>
				<div class="list-group-item">
					No tags have been added yet.
				</div>
			</div>
			{% endfor %}
			<link rel="stylesheet" type="text/css" href="{% static 'vid_manager/preview.css' %}">
		</div>
	</div>
</div>
<div class="d-flex justify-content-center mt-4">
	<span class="current">
		Page {{ tags.number }} of {{ tags.paginator.num_pages }}
	</span>
</div>
<div class="pagination d-flex justify-content-center">
	<span class="step-links">
		{% if tags.has_previous %}
			<a class="btn btn-sm btn-dark" href="?page=1{% if sort %}&{{sort}}{% endif %}">&laquo; first</a>
			<a class="btn btn-sm btn-dark" href="?page={{ tags.previous_page_number }}{% if sort %}&{{sort}}{% endif %}">previous</a>
		{% endif %}
		{% if tags.has_next %}
			<a class="btn btn-sm btn-dark" href="?page={{ tags.next_page_number }}{% if sort %}&{{sort}}{% endif %}">next</a>
			<a class="btn btn-sm btn-dark" href="?page={{ tags.paginator.num_pages }}{% if sort %}&{{sort}}{% endif %}">last &raquo;</a>
		{% endif %}
	</span>
</div>
<script>
	var input = document.getElementById('pnum');
	input.addEventListener("keyup",function(event) {
		if (event.keyCode === 13) {
			var link = document.getElementById('plink');
			link.href = "?page=".concat(input.value, '{% if sort %}&sort={{sort}}{% endif %}');
			link.click();
		}
	});
	$("#tag_form").submit(function (e) {
		e.preventDefault();
		var serializedData = $(this).serialize();
		$.ajax({
			type: 'POST',
			url: "{% url 'new_tag' %}",
			data: serializedData,
			success: function (response) {
				$(".messages").empty();
				$("#tag_form").trigger('reset');
				$("#id_tag_name").focus();
				var instance = JSON.parse(response["instance"]);
				var fields = instance[0]["fields"];
				var pk = instance[0]["pk"];
				var new_url = "{% url 'tag' 0 %}".replace('0', pk);
				$('.messages').prepend(`<div class="rounded px-4 by-3 bg-success">Tag "${fields['tag_name']}"has been added.</div>`);
				$("#tags .tagrow").prepend(`<div class="mb-4 col-sm-6 col-md-4 col-lg-3 col-xl-2 pb-3 px-1"><a href="${new_url}"><div class="preview"><img src="{% load static %}{% static 'vid_manager/blank_image.png' %}" height="auto" width="100%" alt=''><div class="top-left">${fields['tag_name']}</div></div></a></div>`);
			},
			error: function (response) {
				alert(response["responseJSON"]["error"]);
			}
		})
	})
</script>
{% endblock %}